<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analytics Dashboard - ProAnz</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      body {
        background:
          linear-gradient(rgba(248, 249, 250, 0.9), rgba(248, 249, 250, 0.9)),
          url("https://images.unsplash.com/photo-1551288049-bebda4e38f71?ixlib=rb-4.0.3&auto=format&fit=crop&w=2070&q=80")
            no-repeat center center fixed;
        background-size: cover;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: #333;
      }
      .navbar {
        background: linear-gradient(
          135deg,
          #667eea 0%,
          #764ba2 100%
        ) !important;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .navbar-brand {
        font-weight: bold;
        color: white !important;
        font-size: 1.5rem;
      }
      .navbar-nav .nav-link {
        color: white !important;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      .navbar-nav .nav-link:hover {
        color: #f8f9fa !important;
        transform: translateY(-2px);
      }
      .main-container {
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 30px;
        margin-top: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
      }
      .chart-container {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
        transition: all 0.3s ease;
      }
      .chart-container:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }
      .nav-tabs .nav-link {
        color: #667eea;
        font-weight: 600;
        border: none;
        background: transparent;
      }
      .nav-tabs .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px 10px 0 0;
      }

      /* AI Insights Styles */
      .insight-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(102, 126, 234, 0.1);
      }

      .insight-section h3 {
        color: #2c3e50;
        font-weight: 700;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 3px solid #667eea;
        background: linear-gradient(
          135deg,
          rgba(102, 126, 234, 0.1),
          transparent
        );
        border-radius: 10px;
      }

      .insight-section .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        margin-bottom: 20px;
      }

      .insight-section .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }

      .insight-section .card-header {
        border: none;
        border-radius: 12px 12px 0 0;
        font-weight: 600;
        font-size: 0.9rem;
      }

      .insight-section .card-body {
        padding: 20px;
      }

      .insight-section .card-body ul {
        margin: 0;
        padding-left: 20px;
      }

      .insight-section .card-body li {
        margin-bottom: 8px;
        line-height: 1.5;
      }

      .ai-badge {
        display: inline-block;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 10px;
      }

      .ai-insights-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        margin-bottom: 25px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
      }

      .ai-insights-header h4 {
        margin: 0;
        font-weight: 700;
      }

      .ai-insights-header p {
        margin: 5px 0 0 0;
        opacity: 0.9;
        font-size: 0.9rem;
      }

      .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
      }

      .back-button {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
      }

      /* Fix modal backdrop issues */
      .modal-backdrop {
        z-index: 1040 !important;
      }

      .modal {
        z-index: 1050 !important;
      }

      .modal.show {
        z-index: 1055 !important;
      }

      /* Ensure modal content is clickable */
      .modal-content {
        position: relative;
        z-index: 1060 !important;
      }

      /* Fix table hover in modal */
      .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.075);
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
      <div class="container">
        <a
          class="navbar-brand d-flex align-items-center gap-2"
          href="http://localhost:5173"
        >
          <div
            style="
              width: 32px;
              height: 32px;
              border-radius: 8px;
              background: linear-gradient(
                to bottom right,
                #06b6d4,
                #a855f7,
                #ec4899
              );
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              style="width: 20px; height: 20px; color: white"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M12 2L2 7l10 5 10-5-10-5z" />
              <path d="M2 17l10 5 10-5" />
              <path d="M2 12l10 5 10-5" />
            </svg>
          </div>
          <span>ShopSense<span style="color: #22d3ee">AI</span></span>
        </a>
        <div class="navbar-nav ms-auto">
          <div class="nav-item dropdown">
            <a
              class="nav-link dropdown-toggle"
              href="#"
              id="userDropdown"
              role="button"
              data-bs-toggle="dropdown"
            >
              <i class="fas fa-user-circle me-1"></i>
              <span id="currentUsername">User</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <a class="dropdown-item" href="/" onclick="showUploadHistory()">
                  <i class="fas fa-upload me-2"></i>Upload New Data
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="#" onclick="showUploadHistory()">
                  <i class="fas fa-history me-2"></i>Upload History
                </a>
              </li>
              <li><hr class="dropdown-divider" /></li>
              <li>
                <a class="dropdown-item" href="#" onclick="logout()">
                  <i class="fas fa-sign-out-alt me-2"></i>Logout
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Container -->
    <div class="container">
      <div class="main-container">
        <!-- Header -->
        <div class="text-center mb-4">
          <h2 class="mb-3">
            <i class="bi bi-graph-up text-primary me-2"></i>
            Analytics Dashboard
          </h2>
          <p class="text-muted">
            Upload Session:
            <span id="uploadId" class="badge bg-primary">Loading...</span>
          </p>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading-spinner">
          <div class="text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading analytics data...</p>
          </div>
        </div>

        <!-- Dashboard Content (Hidden Initially) -->
        <div id="dashboardContent" style="display: none">
          <!-- Tabs -->
          <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button
                class="nav-link active"
                id="charts-tab"
                data-bs-toggle="tab"
                data-bs-target="#charts"
                type="button"
                role="tab"
              >
                <i class="bi bi-bar-chart"></i> Charts
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="insights-tab"
                data-bs-toggle="tab"
                data-bs-target="#insights"
                type="button"
                role="tab"
              >
                <i class="bi bi-lightbulb"></i> Business Insights
                <span class="ai-badge">AI</span>
              </button>
            </li>
          </ul>

          <div class="tab-content" id="dashboardTabsContent">
            <!-- Charts Tab -->
            <div class="tab-pane fade show active" id="charts" role="tabpanel">
              <div class="row">
                <div class="col-lg-6">
                  <div class="chart-container fade-in">
                    <div id="mostSellingChart"></div>
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="chart-container fade-in">
                    <div id="lowSellingChart"></div>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-6">
                  <div class="chart-container fade-in">
                    <div id="highCostChart"></div>
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="chart-container fade-in">
                    <div id="lowCostChart"></div>
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-6">
                  <div class="chart-container fade-in">
                    <div id="predictionChart"></div>
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="chart-container fade-in">
                    <div id="reportChart"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Insights Tab -->
            <div class="tab-pane fade" id="insights" role="tabpanel">
              <div id="insightsContent"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Back to Upload Button -->
    <div class="back-button">
      <a href="/" class="btn btn-primary btn-lg rounded-circle shadow">
        <i class="fas fa-arrow-left"></i>
      </a>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
      // Get upload ID from URL
      const urlParams = new URLSearchParams(window.location.search);
      const uploadId = urlParams.get("upload_id");

      if (!uploadId) {
        alert("No upload ID provided. Redirecting to main page...");
        window.location.href = "/";
      }

      // Set upload ID in UI
      document.getElementById("uploadId").textContent = uploadId;

      // Fetch dashboard data
      async function fetchDashboardData() {
        try {
          const response = await fetch(`/api/dashboard/${uploadId}`);
          if (!response.ok) {
            throw new Error("Failed to fetch dashboard data");
          }

          const data = await response.json();

          if (data.error) {
            throw new Error(data.error);
          }

          // Hide loading, show content
          document.getElementById("loadingState").style.display = "none";
          document.getElementById("dashboardContent").style.display = "block";

          // Display charts and insights
          displayDashboardData(data);
        } catch (error) {
          console.error("Error fetching dashboard data:", error);
          document.getElementById("loadingState").innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Error loading dashboard: ${error.message}
                    </div>
                `;
        }
      }

      function displayDashboardData(data) {
        // Display charts
        if (data.most_selling && window.Plotly) {
          try {
            Plotly.newPlot(
              "mostSellingChart",
              JSON.parse(data.most_selling.graph),
            );
            const note = document.createElement("p");
            note.className = "text-muted mt-2";
            note.textContent = data.most_selling.note;
            document
              .querySelector("#mostSellingChart")
              .parentElement.appendChild(note);
          } catch (error) {
            console.error("Error rendering most selling chart:", error);
          }
        }

        if (data.low_selling && window.Plotly) {
          try {
            Plotly.newPlot(
              "lowSellingChart",
              JSON.parse(data.low_selling.graph),
            );
            const note = document.createElement("p");
            note.className = "text-muted mt-2";
            note.textContent = data.low_selling.note;
            document
              .querySelector("#lowSellingChart")
              .parentElement.appendChild(note);
          } catch (error) {
            console.error("Error rendering low selling chart:", error);
          }
        }

        if (data.high_cost_high_sales && window.Plotly) {
          try {
            Plotly.newPlot(
              "highCostChart",
              JSON.parse(data.high_cost_high_sales.graph),
            );
            const note = document.createElement("p");
            note.className = "text-muted mt-2";
            note.textContent = data.high_cost_high_sales.note;
            document
              .querySelector("#highCostChart")
              .parentElement.appendChild(note);
          } catch (error) {
            console.error("Error rendering high cost chart:", error);
          }
        }

        if (data.low_cost_high_sales && window.Plotly) {
          try {
            Plotly.newPlot(
              "lowCostChart",
              JSON.parse(data.low_cost_high_sales.graph),
            );
            const note = document.createElement("p");
            note.className = "text-muted mt-2";
            note.textContent = data.low_cost_high_sales.note;
            document
              .querySelector("#lowCostChart")
              .parentElement.appendChild(note);
          } catch (error) {
            console.error("Error rendering low cost chart:", error);
          }
        }

        if (data.sales_prediction && window.Plotly) {
          try {
            Plotly.newPlot(
              "predictionChart",
              JSON.parse(data.sales_prediction.graph),
            );
            const note = document.createElement("p");
            note.className = "text-muted mt-2";
            note.textContent = data.sales_prediction.note;
            document
              .querySelector("#predictionChart")
              .parentElement.appendChild(note);
          } catch (error) {
            console.error("Error rendering prediction chart:", error);
          }
        }

        if (data.product_report && window.Plotly) {
          try {
            Plotly.newPlot(
              "reportChart",
              JSON.parse(data.product_report.graph),
            );
            const note = document.createElement("p");
            note.className = "text-muted mt-2";
            note.textContent = data.product_report.note;
            document
              .querySelector("#reportChart")
              .parentElement.appendChild(note);
          } catch (error) {
            console.error("Error rendering report chart:", error);
          }
        }

        // Display AI insights
        if (data.ai_insights) {
          displayAIInsights(data.ai_insights);
        }
      }

      function displayAIInsights(ai_insights) {
        const insightsContainer = document.getElementById("insightsContent");
        insightsContainer.innerHTML = "";

        if (!ai_insights || !ai_insights.ai_insights) {
          insightsContainer.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        AI-powered business insights are not available for this upload.
                    </div>
                `;
          return;
        }

        const insights = ai_insights.ai_insights;

        // Executive Summary
        if (insights.executive_summary) {
          const exec = insights.executive_summary;
          insightsContainer.innerHTML += `
                    <div class="insight-section mb-4">
                        <h3 class="mb-3">
                            <i class="bi bi-star-fill text-warning me-2"></i>${exec.title}
                        </h3>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="alert alert-primary">
                                    <h5>Key Takeaways</h5>
                                    <ul>
                                        ${exec.key_takeaways.map((takeaway) => `<li>${takeaway}</li>`).join("")}
                                    </ul>
                                </div>
                                <div class="alert alert-success">
                                    <h5>Critical Success Factors</h5>
                                    <ul>
                                        ${exec.critical_success_factors.map((factor) => `<li>${factor}</li>`).join("")}
                                    </ul>
                                </div>
                                <div class="alert alert-info">
                                    <h5>Recommended Next Steps</h5>
                                    <ul>
                                        ${exec.next_steps.map((step) => `<li>${step}</li>`).join("")}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        }

        // Performance Analysis
        if (insights.performance_analysis) {
          const perf = insights.performance_analysis;
          insightsContainer.innerHTML += `
                    <div class="insight-section mb-4">
                        <h3 class="mb-3">
                            <i class="bi bi-graph-up text-success me-2"></i>${perf.title}
                        </h3>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6><i class="bi bi-trophy me-2"></i>Top Performers</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul>
                                            ${perf.top_performers.map((performer) => `<li><strong>${performer}</strong></li>`).join("")}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <h6><i class="bi bi-exclamation-triangle me-2"></i>Improvement Areas</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul>
                                            ${perf.improvement_areas.map((area) => `<li>${area}</li>`).join("")}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6><i class="bi bi-lightbulb me-2"></i>Key Insights</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul>
                                            ${perf.key_insights.map((insight) => `<li>${insight}</li>`).join("")}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        }

        // Market Insights
        if (insights.market_insights) {
          const market = insights.market_insights;
          insightsContainer.innerHTML += `
                    <div class="insight-section mb-4">
                        <h3 class="mb-3">
                            <i class="bi bi-globe text-primary me-2"></i>${market.title}
                        </h3>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h6><i class="bi bi-graph-up-arrow me-2"></i>Market Trends</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul>
                                            ${market.trends.map((trend) => `<li>${trend}</li>`).join("")}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6><i class="bi bi-star me-2"></i>Opportunities</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul>
                                            ${market.opportunities.map((opp) => `<li>${opp}</li>`).join("")}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6><i class="bi bi-compass me-2"></i>Recommendations</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul>
                                            ${market.recommendations.map((rec) => `<li>${rec}</li>`).join("")}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        }

        // Strategic Recommendations
        if (insights.strategic_recommendations) {
          const strategy = insights.strategic_recommendations;
          insightsContainer.innerHTML += `
                    <div class="insight-section mb-4">
                        <h3 class="mb-3">
                            <i class="bi bi-flag text-danger me-2"></i>${strategy.title}
                        </h3>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card border-danger">
                                    <div class="card-header bg-danger text-white">
                                        <h6><i class="bi bi-lightning me-2"></i>Immediate Actions</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul>
                                            ${strategy.immediate_actions.map((action) => `<li><strong>${action}</strong></li>`).join("")}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <h6><i class="bi bi-calendar-week me-2"></i>Short-term Strategies</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul>
                                            ${strategy.short_term_strategies.map((strat) => `<li>${strat}</li>`).join("")}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h6><i class="bi bi-calendar-month me-2"></i>Long-term Initiatives</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul>
                                            ${strategy.long_term_initiatives.map((init) => `<li>${init}</li>`).join("")}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        }

        // Financial Insights
        if (insights.financial_insights) {
          const financial = insights.financial_insights;
          insightsContainer.innerHTML += `
                    <div class="insight-section mb-4">
                        <h3 class="mb-3">
                            <i class="bi bi-currency-dollar text-success me-2"></i>${financial.title}
                        </h3>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6><i class="bi bi-graph-up me-2"></i>Revenue Optimization</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul>
                                            ${financial.revenue_optimization.map((opt) => `<li>${opt}</li>`).join("")}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <h6><i class="bi bi-scissors me-2"></i>Cost Reduction</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul>
                                            ${financial.cost_reduction.map((cost) => `<li>${cost}</li>`).join("")}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6><i class="bi bi-tags me-2"></i>Pricing Strategy</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul>
                                            ${financial.pricing_strategy.map((price) => `<li>${price}</li>`).join("")}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        }

        // Operational Efficiency
        if (insights.operational_efficiency) {
          const ops = insights.operational_efficiency;
          insightsContainer.innerHTML += `
                    <div class="insight-section mb-4">
                        <h3 class="mb-3">
                            <i class="bi bi-gear text-info me-2"></i>${ops.title}
                        </h3>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h6><i class="bi bi-box-seam me-2"></i>Inventory Insights</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul>
                                            ${ops.inventory_insights.map((insight) => `<li>${insight}</li>`).join("")}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6><i class="bi bi-arrow-repeat me-2"></i>Process Improvements</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul>
                                            ${ops.process_improvements.map((improvement) => `<li>${improvement}</li>`).join("")}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6><i class="bi bi-cpu me-2"></i>Technology Opportunities</h6>
                                    </div>
                                    <div class="card-body">
                                        <ul>
                                            ${ops.technology_opportunities.map((tech) => `<li>${tech}</li>`).join("")}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
        }
      }

      // Authentication functions
      function logout() {
        fetch("/api/auth/logout", { method: "POST" }).then(
          () => (window.location.href = "/auth"),
        );
      }

      async function showUploadHistory() {
        // Remove any existing backdrops and modal-open classes
        document
          .querySelectorAll(".modal-backdrop")
          .forEach((el) => el.remove());
        document.body.classList.remove("modal-open");
        document.body.style.overflow = "";
        document.body.style.paddingRight = "";

        const modalElement = document.getElementById("uploadHistoryModal");
        const content = document.getElementById("uploadHistoryContent");

        // Reset modal state
        modalElement.classList.remove("show", "fade");
        modalElement.style.display = "none";
        modalElement.style.visibility = "hidden";

        content.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;

        // Show modal without backdrop
        modalElement.style.display = "block";
        modalElement.style.visibility = "visible";
        modalElement.classList.add("show");
        document.body.classList.add("modal-open");

        try {
          const response = await fetch("/api/auth/upload-history");
          const data = await response.json();

          if (data.success) {
            displayUploadHistory(data.uploads);
          } else {
            content.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Failed to load upload history: ${data.error}
                        </div>
                    `;
          }
        } catch (error) {
          console.error("Upload history error:", error);
          content.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Network error loading upload history
                    </div>
                `;
        }
      }

      function displayUploadHistory(uploads) {
        const content = document.getElementById("uploadHistoryContent");

        if (uploads.length === 0) {
          content.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No Upload History</h5>
                        <p class="text-muted">You haven't uploaded any data yet.</p>
                    </div>
                `;
          return;
        }

        const table = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Date & Time</th>
                                <th>File Name</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${uploads
                              .map(
                                (upload) => `
                                <tr>
                                    <td>${formatDate(upload.created_at)}</td>
                                    <td>${upload.filename}</td>
                                    <td>
                                        <span class="badge bg-${upload.file_type === "csv" ? "primary" : "info"}">
                                            ${upload.file_type.toUpperCase()}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-${getStatusColor(upload.status)}">
                                            ${upload.status.toUpperCase()}
                                        </span>
                                    </td>
                                    <td>
                                        ${
                                          upload.status === "completed"
                                            ? `
                                            <button class="btn btn-sm btn-outline-primary" onclick="viewUploadDetails('${upload.upload_id}')">
                                                <i class="fas fa-eye me-1"></i>View Results
                                            </button>
                                        `
                                            : `
                                            <span class="text-muted">
                                                <i class="fas fa-clock me-1"></i>Processing...
                                            </span>
                                        `
                                        }
                                    </td>
                                </tr>
                            `,
                              )
                              .join("")}
                        </tbody>
                    </table>
                </div>
            `;

        content.innerHTML = table;
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString();
      }

      function closeUploadHistoryModal() {
        const modalElement = document.getElementById("uploadHistoryModal");
        modalElement.classList.remove("show");
        modalElement.style.display = "none";
        modalElement.style.visibility = "hidden";
        document.body.classList.remove("modal-open");
        document.body.style.overflow = "";
        document.body.style.paddingRight = "";
      }

      function getStatusColor(status) {
        switch (status) {
          case "completed":
            return "success";
          case "processing":
            return "warning";
          case "failed":
            return "danger";
          default:
            return "secondary";
        }
      }

      async function viewUploadDetails(uploadId) {
        // Navigate to the dashboard with the upload ID
        window.location.href = `/dashboard?upload_id=${uploadId}`;
      }
      async function checkAuthStatus() {
        try {
          const response = await fetch("/api/auth/current-user");
          const data = await response.json();

          if (data.success) {
            currentUser = data.user;
            document.getElementById("currentUsername").textContent =
              data.user.username;
          } else {
            window.location.href = "/auth";
          }
        } catch (error) {
          console.error("Auth check failed:", error);
          window.location.href = "/auth";
        }
      }
      // Initialize dashboard on page load
      document.addEventListener("DOMContentLoaded", function () {
        fetchDashboardData();
        checkAuthStatus();
      });
    </script>

    <!-- Upload History Modal -->
    <div class="modal fade" id="uploadHistoryModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-history me-2"></i>Upload History
            </h5>
            <button
              type="button"
              class="btn-close"
              onclick="closeUploadHistoryModal()"
            ></button>
          </div>
          <div class="modal-body">
            <div id="uploadHistoryContent">
              <div class="text-center">
                <div class="spinner-border" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
